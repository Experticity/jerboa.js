"use strict";window.jerboa=function(){function e(t,n){if("BODY"===t.tagName)return"body"+(n?" > "+n:"");if(t.id)return"#"+t.id+(n?" > "+n:"");var a=Array.prototype.slice.call(t.parentElement.children).indexOf(t),i=t.tagName.toLowerCase()+":nth-child("+(a+1)+")"+(n?" > "+n:"");return e(t.parentElement,i)}function t(e,t){p[e]&&p[e].forEach(function(e){return e(t)})}function n(e,t){var n=a(e),i=a(t);return[n[0]-i[0],n[1]-i[1]]}function a(e){return[e.offsetLeft,e.offsetTop]}function i(e,t){return t(e)?e:"HTML"===e.tagName?null:i(e.parentElement,t)}function o(e){var t,n,i=e.position,o=document.querySelector(i.container),r=a(o),c=document.createElement("div");if(c.classList.add("feedback-spot"),"pixel"===i.positioning)t=r[0]+i.offset[0],n=r[1]+i.offset[1];else if("percent"===i.positioning){var d=i.offset[0]/i.containerSize.width,l=i.offset[1]/i.containerSize.height,s=o.getBoundingClientRect();t=r[0]+s.width*d,n=r[1]+s.height*l}return c.style.top=n+"px",c.style.left=t+"px",document.body.appendChild(c),c}function r(e,t){e.addEventListener("click",function(n){n.stopPropagation(),t&&(e.classList.toggle("active"),x!==e?(s(),x=e):x=null)});var n=document.createElement("div");n.classList.add("feedback-box"),t&&n.classList.add("toggled"),n.addEventListener("click",function(e){e.stopPropagation()}),e.appendChild(n);var a=document.createElement("div");return a.classList.add("feedback-container"),n.appendChild(a),{box:n,container:a}}function c(e,t){var n=document.createElement("div");n.classList.add("feedback-text"),n.textContent=t.text,e.appendChild(n);var a=document.createElement("div");a.classList.add("feedback-info");var i=new Date(t.datetime);a.textContent="By "+(t.user||"unknown user")+" at "+i.toLocaleString(),n.appendChild(a)}function d(e,t){var n=document.createElement("div");e.appendChild(n);var a=document.createElement("label");a.textContent=t,n.appendChild(a);var i=document.createElement("textarea");n.appendChild(i);var o=document.createElement("div");o.classList.add("button-holder"),n.appendChild(o);var r=document.createElement("button");r.classList.add("cancel-button"),r.innerText="Cancel",o.appendChild(r);var c=document.createElement("button");return c.classList.add("save-button"),c.innerText="Save",o.appendChild(c),{cancel:r,save:c,textarea:i,container:n}}function l(e,n){var a=r(e,!0);c(a.container,n),n.replies.forEach(function(e){c(a.container,e)});var i=d(a.container,"Reply:");i.cancel.addEventListener("click",function(){var e={datetime:(new Date).toISOString(),user:g,text:i.textarea.value};i.textarea.value="",t("cancelReply",e),s()}),i.save.addEventListener("click",function(){var e={datetime:(new Date).toISOString(),user:g,text:i.textarea.value};i.textarea.value="",n.replies.push(e),t("saveReply",n),a.container.removeChild(i.container),c(a.container,e),a.container.appendChild(i.container)})}function s(){x&&(x.classList.remove("active"),x=null)}function u(t){var a=i(t.target,m);if(a){var o=e(t.target),r=e(a),c=n(t.target,a);c[0]+=t.offsetX,c[1]+=t.offsetY;var d=a.getBoundingClientRect(),l={positioning:h,target:o,container:r,containerSize:{width:d.width,height:d.height},windowSize:{width:window.innerWidth,height:window.innerHeight},offset:c};return{datetime:(new Date).toISOString(),position:l,url:window.location.href,data:E,user:g,replies:[]}}}function f(e){if(s(),!v){var n=u(e);if(n){t("preAnnotate",n),v=!0;var a=o(n),i=r(a,!1),c=d(i.container,"Enter message:");c.cancel.addEventListener("click",function(){t("cancel",n),v=!1,document.body.removeChild(a)}),c.save.addEventListener("click",function(){n.text=c.textarea.value,t("save",n),v=!1,a.removeChild(i.box),l(a,n)})}}}var v=!1,p={},m=void 0,h=void 0,g=void 0,E=void 0,x=void 0,L={global:function(e){return"BODY"===e.tagName},byClass:function(e){return function(t){return t.classList.contains(e)}}};return{init:function(e){e=e||{},e.data&&(E=e.data),e.points&&e.points.forEach(function(e){var t=o(e);l(t,e)}),m=e.strategy||L.global,h=e.positioning||"pixel",g=e.user,document.addEventListener("click",f)},close:function(){document.removeEventListener("click",f)},addEventListener:function(e,t){p[e]||(p[e]=[]),p[e].push(t)},strategies:L}}();